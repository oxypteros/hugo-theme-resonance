name: Generate Dev Stack Badges
on:
  push:
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract Versions & Generate Badges
        run: |
          mkdir -p .github/badges


          # generate_badge "PackageName" "JsonField" "Color" "LogoSlug" "LogoColor" "LabelColor"
          generate_badge() {
            NAME=$1
            PACKAGE_JSON_KEY=$2
            COLOR=$3
            LOGO=$4
            LOGO_COLOR=$5
            LABEL_COLOR=$6
            
            RAW_VERSION=$(jq -r ".devDependencies[\"$PACKAGE_JSON_KEY\"] // .dependencies[\"$PACKAGE_JSON_KEY\"]" package.json)
            
            # Package is missing test
            if [ "$RAW_VERSION" == "null" ] || [ -z "$RAW_VERSION" ]; then
                echo "âš ï¸  $NAME ($PACKAGE_JSON_KEY) not found in package.json. Skipping badge."
                return 0 
            fi
            
            # Strip ^, ~, v characters and keep only MAJOR.MINOR
            VERSION=$(jq -r ".devDependencies[\"$PACKAGE_JSON_KEY\"] // .dependencies[\"$PACKAGE_JSON_KEY\"]" package.json | sed 's/[\^~v]//g' | cut -d. -f1,2)
            
            if [ "$VERSION" == "null" ] || [ -z "$VERSION" ]; then
                VERSION="latest"
            fi

            echo "âœ… Found $NAME version: $VERSION. Generating Badge..."

            # Download SVG
            curl -s -G "https://img.shields.io/badge/$NAME-$VERSION-$COLOR" \
              -d style=flat \
              -d logo=$LOGO \
              -d logoColor=$LOGO_COLOR \
              -d labelColor=%23$LABEL_COLOR \
              > .github/badges/$LOGO.svg
          }

          # Node Stack badges

          # Alpine
          generate_badge "AlpineJs" "@alpinejs/csp" "8BC0D0" "alpinedotjs" "8BC0D0" "F0F0F0"

          # Tailwind
          generate_badge "Tailwind" "tailwindcss" "06B6D4" "tailwindcss" "06B6D4" "F0F0F0"

          # Hugo version 
          HUGO_VERSION=$(grep "hugo-version:" .github/workflows/playwright.yml | awk -F"'" '{print $2}')

          curl -s -G "https://img.shields.io/badge/Hugo-$HUGO_VERSION-FF4088" \
            -d style=flat \
            -d logo=hugo \
            -d logoColor=%23FF4088 \
            -d labelColor=%23F0F0F0 \
            > .github/badges/hugo.svg

      - name: Commit Badges
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ¤– Update Stack Versions [skip ci]'
          file_pattern: .github/badges/*.svg
