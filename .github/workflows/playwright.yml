name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Read Hugo Version from Engines
        id: hugo-config
        run: |
          VERSION=$(jq -r '.engines.hugo' package.json)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ steps.hugo-config.outputs.VERSION }}
          extended: true

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        id: playwright
        run: npx playwright test
        continue-on-error: true

      - name: Generate Playwright Badge (Temp)
        run: |
          # Create a temp directory outside the git tree
          mkdir -p ../temp_badges_gen

          OUTCOME="${{ steps.playwright.outcome }}"
          COLOR="red"
          MESSAGE="FAIL"

          if [ "$OUTCOME" == "success" ]; then
            COLOR="266429"
            MESSAGE="PASS"
          fi

          echo "Generating badge: Status=$MESSAGE, Color=$COLOR"

          # Download Badge to TEMP folder
          curl "https://img.shields.io/badge/Playwright-$MESSAGE-$COLOR?style=flat&logo=data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgd2lkdGg9IjI0IgogICBoZWlnaHQ9IjI0IgogICBmaWxsPSJub25lIgogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmc0IgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxkZWZzCiAgICAgaWQ9ImRlZnM0IiAvPgogIDxwYXRoCiAgICAgZmlsbD0iI2UyNTc0YyIKICAgICBkPSJtIDkuNzEzLDE1LjkxNSB2IC0xLjUyNyBsIC00LjI0NCwxLjIwMyBjIDAsMCAwLjMxNCwtMS44MjIgMi41MjcsLTIuNDUgMC42NzEsLTAuMTkgMS4yNDQsLTAuMTg4IDEuNzE3LC0wLjA5NyBWIDYuNzggaCAyLjEyNCBBIDEyLjcyNywxMi43MjcgMCAwIDAgMTEuMTk0LDUuMTMzIEMgMTAuODg0LDQuNSAxMC41NjQsNC45MTkgOS44NDEsNS41MjQgOS4zMzEsNS45NSA4LjA0Myw2Ljg1OCA2LjEwNSw3LjM4MSA0LjE2Nyw3LjkwMyAyLjYsNy43NjUgMS45NDUsNy42NTEgMS4wMTksNy40OTEgMC41MzUsNy4yODggMC41OCw3Ljk5MyBjIDAuMDM5LDAuNjIyIDAuMTg3LDEuNTg2IDAuNTI2LDIuODYgMC43MzUsMi43NTcgMy4xNiw4LjA3IDcuNzQ1LDYuODM1IDEuMTk4LC0wLjMyMiAyLjA0MywtMC45NiAyLjYzLC0xLjc3MyBIIDkuNzEyIFogTSAyLjg2NiwxMC44OSA2LjEyNCwxMC4wMzIgYyAwLDAgLTAuMDk1LDEuMjUzIC0xLjMxNywxLjU3NSBDIDMuNTg2LDExLjkyOSAyLjg2NiwxMC44OSAyLjg2NiwxMC44OSBaIgogICAgIGlkPSJwYXRoMSIgLz4KICA8cGF0aAogICAgIGZpbGw9IiMyZWFkMzMiCiAgICAgZD0iTSAyMS45NzUsNi44NTMgQyAyMS4xMjgsNy4wMDEgMTkuMDk2LDcuMTg2IDE2LjU4NSw2LjUxMyAxNC4wNzMsNS44NCAxMi40MDcsNC42NjMgMTEuNzQ2LDQuMTExIDEwLjgxLDMuMzI3IDEwLjM5OSwyLjc4MSA5Ljk5NCwzLjYwNiA5LjYzNSw0LjMzMyA5LjE3Nyw1LjUxNiA4LjczNCw3LjE3MiBjIC0wLjk2LDMuNTg2IC0xLjY3OSwxMS4xNTQgNC4yNiwxMi43NDYgNS45MzgsMS41OTEgOS4xLC01LjMyMiAxMC4wNiwtOC45MDggMC40NDQsLTEuNjU2IDAuNjM4LC0yLjkxIDAuNjkyLC0zLjcxOCAwLjA2MSwtMC45MTYgLTAuNTY4LC0wLjY1IC0xLjc3LC0wLjQ0IHogTSAxMC4wNDIsOS44MTkgYyAwLDAgMC45MzYsLTEuNDU1IDIuNTIzLC0xLjAwNCAxLjU4OSwwLjQ1MSAxLjcxMiwyLjIwNyAxLjcxMiwyLjIwNyBMIDEwLjA0Miw5LjgyIFogbSAzLjg3NSw2LjUzMyBjIC0yLjc5MiwtMC44MTggLTMuMjIzLC0zLjA0NSAtMy4yMjMsLTMuMDQ1IGwgNy41MDEsMi4wOTggYyAwLDAgLTEuNTE0LDEuNzU1IC00LjI3OCwwLjk0NyB6IG0gMi42NTIsLTQuNTc2IGMgMCwwIDAuOTM1LC0xLjQ1NSAyLjUyMiwtMS4wMDIgMS41ODcsMC44NTIgMS43MTIsMi4yMDggMS43MTIsMi4yMDggeiIKICAgICBpZD0icGF0aDIiIC8+CiAgPHBhdGgKICAgICBmaWxsPSIjMmVhZDMzIgogICAgIGQ9Im0gMTQuMDQzLDE2LjM4MyAtMC4xMjYsLTAuMDMxIGMgLTIuNzkzLC0wLjgxOCAtMy4yMjMsLTMuMDQ1IC0zLjIyMywtMy4wNDUgbCAzLjg2OCwxLjA4MiAyLjA0OCwtNy44NyAtMC4wMjUsLTAuMDA2IEMgMTQuMDczLDUuODQgMTIuNDA2LDQuNjYzIDExLjc0Niw0LjExMSAxMC44MSwzLjMyNyAxMC4zOTgsMi43ODEgOS45OTMsMy42MDYgOS42MzUsNC4zMzMgOS4xNzcsNS41MTYgOC43MzMsNy4xNzIgNy43NzMsMTAuNzU4IDcuMDU1LDE4LjMyNiAxMi45OTQsMTkuOTE4IGwgMC4xMjIsMC4wMjggeiBNIDEwLjA0Miw5LjgxOSBjIDAsMCAwLjkzNiwtMS40NTUgMi41MjMsLTEuMDA0IDEuNTg5LDAuNDUxIDEuNzEyLDIuMjA3IDEuNzEyLDIuMjA3IEwgMTAuMDQyLDkuODIgWiIKICAgICBpZD0icGF0aDQiIC8+Cjwvc3ZnPgo=&labelColor=%23F0F0F0" > ../temp_badges_gen/playwright.svg

          # Verify
          if ! grep -q "^<svg" ../temp_badges_gen/playwright.svg; then
            echo "âŒ Error: Downloaded file is not a valid SVG."
            exit 1
          fi

      - name: Deploy Badge (Conditional)
        run: |
          # Configure Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ðŸ” CHECK: Does 'badges' branch exist?
          if git ls-remote --exit-code --heads origin badges; then
            echo "âœ… 'badges' branch detected. Switching..."
            
            git fetch origin badges
            git checkout badges
            
            # Copy to ROOT of badges branch
            cp ../temp_badges_gen/playwright.svg .
            
            TARGET_BRANCH="badges"
          else
            echo "â„¹ï¸ 'badges' branch NOT found. Falling back to .github/badges..."
            
            # Ensure we are on the PR/Main branch
            git checkout ${{ github.ref_name }}
            
            mkdir -p .github/badges
            cp ../temp_badges_gen/playwright.svg .github/badges/
            
            TARGET_BRANCH="${{ github.ref_name }}"
          fi

          # ðŸ’¾ COMMIT & PUSH
          git add .

          if git diff --staged --quiet; then
            echo "No changes to badge."
          else
            git commit -m "ðŸ¤– Update Playwright Badge [skip ci]"
            git push origin $TARGET_BRANCH
            echo "ðŸš€ Pushed to $TARGET_BRANCH"
          fi

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Check for Failures
        if: steps.playwright.outcome == 'failure'
        run: |
          echo "âŒ One or more tests failed."
          exit 1
